<!DOCTYPE html>
<html lang="en">
    <head>
        <meta charset="utf-8">
        <meta http-equiv="X-UA-Compatible" content="IE=edge">
        <meta name="viewport" content="width=device-width, initial-scale=1.0">
        
        
        
        <link rel="shortcut icon" href="../../img/favicon.ico">

	<title>Lab 5 - Log File to API - BMC TrueSight Intelligence</title>

        <link href="../../css/bootstrap-custom.min.css" rel="stylesheet">
        <link href="../../css/font-awesome-4.0.3.css" rel="stylesheet">
        <link rel="stylesheet" href="../../css/highlight.css">
        <link href="../../css/base.css" rel="stylesheet">

        <!-- HTML5 shim and Respond.js IE8 support of HTML5 elements and media queries -->
        <!--[if lt IE 9]>
            <script src="https://oss.maxcdn.com/libs/html5shiv/3.7.0/html5shiv.js"></script>
            <script src="https://oss.maxcdn.com/libs/respond.js/1.3.0/respond.min.js"></script>
        <![endif]-->

        
    </head>

    <body>

        <div class="navbar navbar-default navbar-fixed-top" role="navigation">
    <div class="container">

        <!-- Collapsed navigation -->
        <div class="navbar-header">
            <!-- Expander button -->
            <button type="button" class="navbar-toggle" data-toggle="collapse" data-target=".navbar-collapse">
                <span class="sr-only">Toggle navigation</span>
                <span class="icon-bar"></span>
                <span class="icon-bar"></span>
                <span class="icon-bar"></span>
            </button>

            <!-- Main title -->
            <a class="navbar-brand" href="../..">BMC TrueSight Intelligence</a>
        </div>

        <!-- Expanded navigation -->
        <div class="navbar-collapse collapse">
            <!-- Main navigation -->
            <ul class="nav navbar-nav">
            
            
                <li >
                    <a href="../..">Home</a>
                </li>
            
            
            
                <li class="dropdown">
                    <a href="#" class="dropdown-toggle" data-toggle="dropdown">Getting Started <b class="caret"></b></a>
                    <ul class="dropdown-menu">
                    
                        
<li >
    <a href="../../getting_started/prerequisites/">Prerequisites</a>
</li>

                    
                        
<li >
    <a href="../../getting_started/signup/">Sign-Up</a>
</li>

                    
                        
<li >
    <a href="../../getting_started/virtual_machine/">Virtual Machine</a>
</li>

                    
                    </ul>
                </li>
            
            
            
                <li class="dropdown active">
                    <a href="#" class="dropdown-toggle" data-toggle="dropdown">Labs <b class="caret"></b></a>
                    <ul class="dropdown-menu">
                    
                        
<li >
    <a href="../lab1/">Lab 1 - Meters and Meter Plugins</a>
</li>

                    
                        
<li >
    <a href="../lab2/">Lab 2 - Introduction ReST</a>
</li>

                    
                        
<li >
    <a href="../lab3/">Lab 3 - Event APIs</a>
</li>

                    
                        
<li >
    <a href="../lab4/">Lab 4 - Metrics APIs</a>
</li>

                    
                        
<li class="active">
    <a href="./">Lab 5 - Log File to API</a>
</li>

                    
                        
<li >
    <a href="../lab6/">Lab 6 - API Integration</a>
</li>

                    
                    </ul>
                </li>
            
            
            </ul>

            <!-- Search, Navigation and Repo links -->
            <ul class="nav navbar-nav navbar-right">
                <li>
                    <a href="#" data-toggle="modal" data-target="#mkdocs_search_modal">
                        <i class="fa fa-search"></i> Search
                    </a>
                </li>
                <li >
                    <a rel="next" href="../lab4/">
                        <i class="fa fa-arrow-left"></i> Previous
                    </a>
                </li>
                <li >
                    <a rel="prev" href="../lab6/">
                        Next <i class="fa fa-arrow-right"></i>
                    </a>
                </li>
                
            </ul>
        </div>
    </div>
</div>

        <div class="container">
            <div class="col-md-3"><div class="bs-sidebar hidden-print affix well" role="complementary">
    <ul class="nav bs-sidenav">
    
        <li class="main active"><a href="#lab-5-logfile-to-api">Lab 5 - Logfile to API</a></li>
        
            <li><a href="#overview">Overview</a></li>
        
            <li><a href="#apache-web-server-introduction">Apache Web Server Introduction</a></li>
        
            <li><a href="#introduction-to-exercise-5-1-monitoring-a-logfile">Introduction to Exercise 5-1 Monitoring a Logfile</a></li>
        
            <li><a href="#exercise-5-1-monitoring-a-log-file">Exercise 5-1 - Monitoring A Log File</a></li>
        
            <li><a href="#introduction-to-exercise-5-2-parsing-an-apache-access_log">Introduction to Exercise 5-2 Parsing an Apache access_log</a></li>
        
            <li><a href="#exercise-5-2-parsing-an-apache-access_log">Exercise 5-2 - Parsing an Apache access_log</a></li>
        
            <li><a href="#introduction-to-exercise-5-3-reading-log-files-and-sending-measurements">Introduction to Exercise 5-3 - Reading Log Files and Sending Measurements</a></li>
        
            <li><a href="#exercise-5-3-reading-log-files-and-sending-measurements">Exercise 5-3 - Reading Log Files and Sending Measurements</a></li>
        
    
    </ul>
</div></div>
            <div class="col-md-9" role="main">

<h1 id="lab-5-logfile-to-api">Lab 5 - Logfile to API</h1>
<h2 id="overview">Overview</h2>
<p>This lab will introduce to parsing an Apache HTTP server log to extract measurements that are then sent to
the measurement APIs</p>
<h2 id="apache-web-server-introduction">Apache Web Server Introduction</h2>
<p>The <a href="https://en.wikipedia.org/wiki/Apache_HTTP_Server">Apache HTTP Server</a> has a long history with
its initial release in 1995. The Apache HTTP Server is descendant of the
<a href="https://en.wikipedia.org/wiki/NCSA_HTTPd">NCSA HTTPd Server</a> and was started when development on the
NCSA HTTPd Server stalled.</p>
<p>A key feature of the Apache Web Server is the ability to log received requests to a log file of
your choosing and format. The out of the box file is named <code>access_log</code> and on RHEL/Centos platforms
the path to the file is <code>/var/log/httpd/access_log</code>. The default format of the log file is referred to
as <code>combined</code>. Information about received requests are continuously appended to the log file.</p>
<p>To extract useful content from the log file at we need to perform the following:</p>
<ol>
<li>Continuously read the log file looking for new requests appended to the log.</li>
<li>For each line parse the content knowing the format of each line or record.</li>
<li>Extract the content of interest by filtering and searching each line or record.</li>
<li>Send the extract content to TrueSight Intelligence using the Measurement API.</li>
</ol>
<h2 id="introduction-to-exercise-5-1-monitoring-a-logfile">Introduction to <em>Exercise 5-1 Monitoring a Logfile</em></h2>
<p>A useful unix utility <a href="https://en.wikipedia.org/wiki/Tail_(Unix)"><code>tail</code></a> permits the monitoring of a log
file and outputs new lines or records as they are written to the file. An example of using this utility is shown
here:</p>
<pre><code>$ tail -f /var/log/cron
</code></pre>

<p>which is a log that shows <a href="https://en.wikipedia.org/wiki/Cron"><code>cron</code></a> jobs that have been executed by the system.</p>
<p>For this exercise we will introduce the same capability by in Python code as shown here:</p>
<pre><code>def follow(f):
    &quot;&quot;&quot;
    Reads a line from a file when available
    :param f: open file
    :return: a line from the file
    &quot;&quot;&quot;
    # Go to the end of the file
    f.seek(0, 2)

    # Loop waiting for lines to be written
    while True:
        log_line = f.readline()
        # If there is nothing to read then wait a bit
        # and try again
        if not log_line:
            time.sleep(0.1)
            continue
        # We have a line return the line
        yield log_line
</code></pre>

<p>This function uses one of the esoteric features of python namely <code>yield</code>. Suffice to the say the above function
returns a line which is append in the file everytime <code>yield log_line</code> is executed. This function <em>generates</em> log lines
from the passed in open file and can be iterated over as shown in this Python snippet:</p>
<pre><code># Open our file for reading
log_file = open(sys.argv[1], &quot;r&quot;)

# Create our iterable function
log_lines = monitor_file(log_file)

# Process the lines as they are appended to the file
for line in log_lines:
    # Strip out the new line an print the line
    print(&quot;{0}&quot;.format(line.strip()))
</code></pre>

<p>if you want to have a deep understanding of how this works take a look at this
<a href="https://wiki.python.org/moin/Generators">page</a></p>
<p>Okay, onward to run some examples of what we just learned.</p>
<h2 id="exercise-5-1-monitoring-a-log-file">Exercise 5-1 - Monitoring A Log File</h2>
<p>Is this exercise we will run a complete script that opens a file named on the command line
and writes out the lines append to the file.</p>
<ol>
<li>
<p>Change directory to <code>labs/lab-5</code></p>
<p><code>[vagrant@tsi-lab-01 ~]$ cd labs/lab-5/</code></p>
</li>
<li>
<p>Run the script against the <code>/var/log/messages</code> file which is generated by the syslog daemon. You
can monitor what is being written to this file by by running the following command (<em>NOTE</em>: the prefixed
<code>sudo</code> command is required since <code>/var/log/messages</code> is read-only by the <code>root</code> user):</p>
<p><code>vagrant@tsi-lab-01 lab-5]$ sudo ./ex5-1.log.py /var/log/messages</code></p>
</li>
</ol>
<p>which will present output similar to the following:</p>
<pre><code>Apr 14 20:50:11 localhost one-liners.py[26992]: Two cannibals were eating a clown - one ...
Apr 14 20:50:16 localhost one-liners.py[26992]: How do you tell when you're out of invi ...
Apr 14 20:50:21 localhost one-liners.py[26992]: I have a lot of growing up to do. I rea ...
Apr 14 20:50:26 localhost one-liners.py[26992]: Did you hear about the shrimp that went ...
Apr 14 20:50:31 localhost one-liners.py[26992]: The quickest way to a man's heart is th ...
</code></pre>

<p>If you feeling curious (like the monkey named <a href="https://en.wikipedia.org/wiki/Curious_George">George</a>)
take a gander at the complete script <code>~/labs/lab-5/ex-5-1.log.py</code>.</p>
<h2 id="introduction-to-exercise-5-2-parsing-an-apache-access_log">Introduction to <em>Exercise 5-2 Parsing an Apache <code>access_log</code></em></h2>
<p>One of the beauties of Python is there is a heck of a lot of code out there already written for us
that we can leverage in our own scripts. For this lab we want to show how to parse an Apache HTTP server
log file, but who wants to write the parser, we didn't. A quick search of the internet (The thing invented
by former senator and vice president <a href="https://en.wikipedia.org/wiki/Information_superhighway">Al Gore</a>) yielded
a suitable Python package ripe for the picking: <code>apachelog</code>. Using
<a href="https://en.wikipedia.org/wiki/Pip_(package_manager)"><code>pip</code></a> we can install this package by the following:</p>
<pre><code>$ pip install apachelog
</code></pre>

<p><em>NOTE</em>: No needed to run this we have already installed this in the virtual machine, but thought
you might want to know for that pet log parsing project down the road.</p>
<p>With our new best friend/package parsing an Apache HTTP server log is now trivial. Here you go, a
quick Python snippet that shows you how easy it is:</p>
<pre><code>import apachelog

log_format = r'%h %l %u %t \&quot;%r\&quot; %&gt;s %b \&quot;%{Referer}i\&quot; \&quot;%{User-Agent}\i&quot;'
p = apachelog.parser(log_format)
parsed = p.parse(line)
</code></pre>

<p>In the above snippet the <code>parsed</code> variable contains a Python dictionary with the parsed out log entry with
the format spelled out in <code>log_format</code>. Cool Huh? Here is an example value of what the <code>parsed</code> values contents:</p>
<pre><code>{'%l': '-', '%&gt;s': '200', '%h': '::1', '%b': '481', '%{Referer}i': 'www.bmc.com', '%{User-Agent}\\i&quot;': 'curl/7.29.0', '%u': '-', '%t': '[13/Apr/2016:05:25:25 +0000]', '%r': 'GET / HTTP/1.1'}
</code></pre>

<p>Let's proceed to the exercise.</p>
<h2 id="exercise-5-2-parsing-an-apache-access_log">Exercise 5-2 - Parsing an Apache <code>access_log</code></h2>
<ol>
<li>
<p>Change directory to <code>labs/lab-5</code></p>
<p><code>[vagrant@tsi-lab-01 ~]$ cd labs/lab-5/</code></p>
</li>
<li>
<p>Run the following command with sample <code>access_log</code> provide:</p>
<p><code>vagrant@tsi-lab-01 lab-5]$ ./ex5-2.log.py access_log</code></p>
</li>
</ol>
<p>which displays the following output:</p>
<pre><code>host: ::1, time: [13/Apr/2016:02:35:06 +0000], request: GET / HTTP/1.1, status: 200 ...
host: ::1, time: [13/Apr/2016:02:35:14 +0000], request: GET /favicon HTTP/1.1, stat ...
host: ::1, time: [13/Apr/2016:02:35:21 +0000], request: GET /fav.icon HTTP/1.1, sta ...
host: ::1, time: [13/Apr/2016:02:36:16 +0000], request: GET /favicon.ico HTTP/1.1,  ...
host: ::1, time: [13/Apr/2016:03:21:02 +0000], request: GET /fav HTTP/1.1, status:  ...
host: ::1, time: [13/Apr/2016:03:26:30 +0000], request: GET /favicon.ico HTTP/1.1,  ...
host: ::1, time: [13/Apr/2016:05:24:35 +0000], request: GET / HTTP/1.0, status: 200 ...
host: ::1, time: [13/Apr/2016:05:25:25 +0000], request: GET / HTTP/1.1, status: 200 ...
</code></pre>
<p>Look at the script <code>~/labs/lab-5/ex5-2.log.py</code> in its entirety to understand how it works.</p>
<h2 id="introduction-to-exercise-5-3-reading-log-files-and-sending-measurements">Introduction to <em>Exercise 5-3 - Reading Log Files and Sending Measurements</em></h2>
<p>Okay, last stop in the logfile saga. In this lab were are going to combine our collected
knowledge on processing log files with our previous lab on sending measurements using
the Measurement API.</p>
<p>But first a quick segway (not this <a href="https://en.wikipedia.org/wiki/Segway_PT">segway</a>!) on
Pythons object oriented programming.</p>
<p>Here is a simple class definition in Python the describes an animal:</p>
<pre><code>class Animal(object):

    def __init__(self):
        self.voice = &quot;???&quot;

    def speak(self):
        print('{0} says &quot;{1}&quot;'.format(self.__class__.__name__, self.voice))
</code></pre>

<p>We can create an instance of this class as follows:</p>
<pre><code>from kingdom import Animal

animal = Animal()
animal.speak()
</code></pre>

<p>which when run outputs the following:</p>
<pre><code>Animal says &quot;???&quot;
</code></pre>

<p>We can derive an new class based upon animal without having to teach it to speak:</p>
<pre><code>from kingdom import Animal

class Cat(Animal):

    def __init__(self):
        super(Cat, self).__init__()
        self.voice = 'Meow!'

cat = Cat()
cat.speak()
</code></pre>

<p>which gives an output of:</p>
<pre><code>Cat says &quot;Meow!&quot;
</code></pre>

<p>Our new <code>Cat</code> class <em>inherits</em> the <code>Animal</code> classes method <code>speak()</code>. Let's create one more
example to cement this concept of
<a href="https://en.wikipedia.org/wiki/Inheritance_(object-oriented_programming)"><em>inheritance</em></a>:</p>
<pre><code>class Dog(Animal):

    def __init__(self):
        super(Dog, self).__init__()
        self.voice = 'Woof!'

dog = Dog()
dog.speak()
</code></pre>

<p>which gives an output of:</p>
<pre><code>Dog says &quot;Woof!&quot;
</code></pre>

<p>In summary, all we had to do to make our new animal say something different was to assign
what the animal says in the new animals creation method '<strong>init</strong>()'.</p>
<p>Neat-O. Okay, one more [OOP (Object Oriented Programming)] before we do the final exercise of
this lab: [overloading].</p>
<p><strong>To Be Completed</strong></p>
<h2 id="exercise-5-3-reading-log-files-and-sending-measurements">Exercise 5-3 - Reading Log Files and Sending Measurements</h2>
<p>For this finally exercise we will use the running Apache HTTP server in the virtual machine
and monitor its <code>access_log</code></p>
<ol>
<li>
<p>Run the following command passing the path to the Apache HTTP server <code>access_log</code>
<em>NOTE</em>: the additional argument to sudo <code>-E</code> which ensures we pass our environment variables
which contain our credentials and api endpoint:
    <code>$ sudo -E ./ex5-3.log.py /var/log/httpd/access_log</code></p>
</li>
<li>
<p>Observe the measurements on TrueSight Intelligence.</p>
</li>
</ol></div>
        </div>

        <footer class="col-md-12">
            <hr>
            
            <center>Documentation built with <a href="http://www.mkdocs.org/">MkDocs</a>.</center>
        </footer>

        <script src="../../js/jquery-1.10.2.min.js"></script>
        <script src="../../js/bootstrap-3.0.3.min.js"></script>
        <script src="../../js/highlight.pack.js"></script>
        <script>var base_url = '../..';</script>
        <script data-main="../../mkdocs/js/search.js" src="../../mkdocs/js/require.js"></script>
        <script src="../../js/base.js"></script>

        <div class="modal" id="mkdocs_search_modal" tabindex="-1" role="dialog" aria-labelledby="Search Modal" aria-hidden="true">
            <div class="modal-dialog">
                <div class="modal-content">
                    <div class="modal-header">
                        <button type="button" class="close" data-dismiss="modal"><span aria-hidden="true">&times;</span><span class="sr-only">Close</span></button>
                        <h4 class="modal-title" id="exampleModalLabel">Search</h4>
                    </div>
                    <div class="modal-body">
                        <p>
                            From here you can search these documents. Enter
                            your search terms below.
                        </p>
                        <form role="form">
                            <div class="form-group">
                                <input type="text" class="form-control" placeholder="Search..." id="mkdocs-search-query">
                            </div>
                        </form>
                        <div id="mkdocs-search-results"></div>
                    </div>
                    <div class="modal-footer">
                    </div>
                </div>
            </div>
        </div>
    </body>
</html>